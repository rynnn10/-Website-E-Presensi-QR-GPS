<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Presensi GPS & QR (Cloud)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js (Generator) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Html5-QRCode (Scanner) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- SweetAlert2 (Alerts) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Scanner Styles */
        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        #reader video {
            object-fit: cover;
            border-radius: 8px;
        }
        
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-md p-6 relative overflow-hidden min-h-[600px]">
        
        <!-- Connection Status -->
        <div class="absolute top-4 right-4 flex items-center gap-2">
            <span id="db-status-text" class="text-[10px] text-gray-400">Menghubungkan...</span>
            <span id="db-status-dot" class="status-dot bg-gray-400 animate-pulse"></span>
        </div>

        <!-- Header -->
        <div class="text-center mb-6 border-b pb-4 mt-2">
            <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-fingerprint text-blue-600 mr-2"></i>E-Presensi</h1>
            <p class="text-sm text-gray-500">Scan QR & Validasi Lokasi</p>
        </div>

        <!-- VIEW: HOME (Role Selection) -->
        <div id="view-home" class="space-y-4">
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 text-center text-xs text-blue-800">
                <i class="fa-solid fa-cloud mr-1"></i> 
                Data lokasi tersimpan di <b>Cloud</b>. Admin cukup setting sekali, semua perangkat akan terupdate.
            </div>

            <button onclick="window.switchView('scan')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-between group">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-4">
                        <i class="fa-solid fa-user-clock text-xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-sm opacity-80">Karyawan</div>
                        <div class="text-lg">Absen Masuk</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right opacity-50 group-hover:translate-x-1 transition"></i>
            </button>

            <button onclick="window.switchView('admin')" class="w-full bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 font-semibold py-4 px-6 rounded-xl shadow-sm transition transform active:scale-95 flex items-center justify-between group">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fa-solid fa-shield-halved text-gray-600 text-xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-sm text-gray-500">Admin / HRD</div>
                        <div class="text-lg">Konfigurasi</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right opacity-30 group-hover:translate-x-1 transition"></i>
            </button>
        </div>

        <!-- VIEW: ADMIN (QR Generator & Config) -->
        <div id="view-admin" class="hidden space-y-4">
            <button onclick="window.switchView('home')" class="text-gray-500 hover:text-blue-600 mb-2 flex items-center text-sm font-medium">
                <i class="fa-solid fa-arrow-left mr-2"></i> Kembali
            </button>
            
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <h3 class="font-bold text-gray-700 mb-2 text-sm"><i class="fa-solid fa-map-pin text-red-500 mr-2"></i>Lokasi Kantor (Cloud)</h3>
                <div class="text-xs text-gray-600 mb-3 text-justify">
                    Masukkan koordinat dari Google Maps. Saat Anda klik Simpan, data ini akan menyebar ke semua HP Karyawan secara otomatis.
                </div>
                
                <!-- INPUT KOORDINAT SATU KOLOM -->
                <div class="mb-3">
                    <label class="text-xs font-bold text-gray-500 block mb-1">Koordinat Maps (Lat, Lon)</label>
                    <div class="flex">
                        <input type="text" id="coord-input" class="w-full text-sm p-2 rounded-l border border-r-0 border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Memuat data...">
                        <button onclick="window.pasteFromClipboard()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded-r border border-l-0 border-gray-300" title="Paste">
                            <i class="fa-solid fa-paste"></i>
                        </button>
                    </div>
                </div>

                <!-- Radius Slider -->
                <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-500">Radius Toleransi</label>
                        <span id="radius-val" class="text-xs font-bold text-blue-600">...</span>
                    </div>
                    <input type="range" id="office-radius" min="20" max="1000" step="10" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="flex gap-2">
                    <button onclick="window.setOfficeLocationToCurrent()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-2 px-2 rounded transition">
                        <i class="fa-solid fa-location-crosshairs"></i> Gunakan GPS Ini
                    </button>
                    <button onclick="window.saveConfigManual()" id="btn-save" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-2 rounded transition">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Simpan ke Cloud
                    </button>
                </div>
                 <div class="mt-2 text-center">
                    <a href="https://www.google.com/maps" target="_blank" class="text-xs text-blue-500 underline">Buka Google Maps (Cari Koordinat)</a>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center p-6 bg-white rounded-xl border border-dashed border-gray-300">
                <div id="qrcode" class="mb-4"></div>
                <p class="text-xs text-gray-400 text-center mb-4">Token QR akan refresh tiap sesi</p>
                <button onclick="window.generateQR()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition">
                    <i class="fa-solid fa-arrows-rotate mr-2"></i> Refresh QR
                </button>
            </div>
        </div>

        <!-- VIEW: SCAN (Employee) -->
        <div id="view-scan" class="hidden flex flex-col h-full">
            <button onclick="window.stopScannerAndBack()" class="text-gray-500 hover:text-blue-600 mb-4 flex items-center text-sm font-medium">
                <i class="fa-solid fa-arrow-left mr-2"></i> Batal
            </button>

            <div class="flex-grow flex flex-col items-center">
                <!-- Status Box -->
                <div class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4 space-y-2">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                         <div>
                            <p class="text-xs text-gray-500">Status GPS</p>
                            <p id="gps-status" class="text-sm font-bold text-orange-500"><i class="fa-solid fa-spinner fa-spin"></i> Mencari...</p>
                        </div>
                        <button onclick="window.startGpsTracking()" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-gray-100">
                            <i class="fa-solid fa-rotate"></i> Retry
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-500">Radius Diizinkan</p>
                            <p id="allowed-radius" class="text-xs font-mono text-blue-600">Loading...</p>
                        </div>
                         <div class="text-right">
                            <p class="text-xs text-gray-500">Jarak ke Kantor</p>
                            <p id="distance-info" class="text-sm font-bold text-gray-700">- m</p>
                        </div>
                    </div>
                </div>

                <!-- Camera Area -->
                <div class="relative w-full bg-black rounded-lg overflow-hidden shadow-xl" style="min-height: 250px;">
                    <div id="reader" class="w-full h-full"></div>
                    <div class="absolute inset-0 border-2 border-blue-500/50 pointer-events-none flex items-center justify-center">
                        <div class="w-48 h-48 border-2 border-white/80 rounded-lg"></div>
                    </div>
                </div>
                
                <!-- Error & Mock Button Container -->
                <div id="error-message-box" class="hidden mt-4 p-3 bg-red-100 text-red-700 text-xs rounded border border-red-200 w-full text-center flex flex-col gap-2">
                    <span id="error-text">Error message here</span>
                    <button onclick="window.enableMockGPS()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-4 rounded w-full animate-bounce">
                        <i class="fa-solid fa-flask mr-1"></i> Gunakan Lokasi Palsu (Testing)
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- MODULE SCRIPT: FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE INIT ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        // --- GLOBAL STATE ---
        window.officeConfig = {
            lat: -6.175392, 
            lon: 106.827153,
            maxDistance: 100
        };

        // --- AUTH & LISTENER ---
        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed", error);
                updateStatus(false, "Auth Error");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateStatus(true, "Terhubung ke Cloud");
                listenToConfig();
            } else {
                updateStatus(false, "Terputus");
            }
        });

        // --- FIRESTORE LOGIC ---
        function listenToConfig() {
            // FIX: Menambahkan segmen 'main' agar path menjadi genap (6 segmen)
            // Path: artifacts/{appId}/public/data/officeConfig/main
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'officeConfig', 'main');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.officeConfig.lat = data.lat;
                    window.officeConfig.lon = data.lon;
                    window.officeConfig.maxDistance = data.radius;

                    console.log("Config Updated from Cloud:", window.officeConfig);
                    
                    updateAdminUIFromConfig();
                    document.getElementById('allowed-radius').innerText = "Max " + window.officeConfig.maxDistance + "m";
                } else {
                    console.log("No config found, creating default...");
                    saveToCloud(window.officeConfig.lat, window.officeConfig.lon, window.officeConfig.maxDistance);
                }
            }, (error) => {
                console.error("Listen failed: ", error);
                // Jangan tampilkan error ke UI status agar user tidak panik
                // Cukup log ke console
            });
        }

        async function saveToCloud(lat, lon, radius) {
            if (!currentUser) {
                Swal.fire('Error', 'Tidak terhubung ke server.', 'error');
                return;
            }

            // FIX: Menggunakan path yang sama dengan listenToConfig (6 segmen)
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'officeConfig', 'main');
            
            try {
                document.getElementById('btn-save').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';
                await setDoc(docRef, {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    radius: parseInt(radius),
                    updatedBy: currentUser.uid,
                    updatedAt: new Date().toISOString()
                });
                
                Swal.fire('Berhasil', 'Lokasi tersimpan di Cloud & tersinkron ke semua perangkat.', 'success');
            } catch (e) {
                console.error("Error saving: ", e);
                Swal.fire('Gagal', 'Gagal menyimpan ke cloud: ' + e.message, 'error');
            } finally {
                document.getElementById('btn-save').innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Simpan ke Cloud';
            }
        }

        // --- EXPOSE TO WINDOW ---
        window.saveConfigManual = function() {
            const rawInput = document.getElementById('coord-input').value;
            const radInput = parseInt(document.getElementById('office-radius').value);

            const parts = rawInput.split(',');
            if (parts.length !== 2) {
                Swal.fire('Format Salah', 'Format: Latitude, Longitude (Contoh: -6.2, 106.8)', 'error');
                return;
            }
            const lat = parseFloat(parts[0].trim());
            const lon = parseFloat(parts[1].trim());

            if(isNaN(lat) || isNaN(lon)) return Swal.fire('Error', 'Koordinat harus angka', 'error');

            saveToCloud(lat, lon, radInput);
            window.generateQR();
        }

        // UI Helpers
        function updateStatus(isOnline, text) {
            const dot = document.getElementById('db-status-dot');
            const txt = document.getElementById('db-status-text');
            txt.innerText = text;
            if(isOnline) {
                dot.className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                dot.classList.remove('animate-pulse');
            } else {
                dot.className = "status-dot bg-red-500";
            }
        }

        function updateAdminUIFromConfig() {
            const elInput = document.getElementById('coord-input');
            const elRadius = document.getElementById('office-radius');
            const elRadVal = document.getElementById('radius-val');

            if(elInput && window.officeConfig.lat) {
                elInput.value = `${window.officeConfig.lat}, ${window.officeConfig.lon}`;
                elRadius.value = window.officeConfig.maxDistance;
                elRadVal.innerText = window.officeConfig.maxDistance + "m";
            }
        }

        // Start App
        initApp();
    </script>

    <!-- CLASSIC SCRIPT: LOCAL LOGIC -->
    <script>
        // --- LOCAL UTILS & NAVIGATION ---
        let userLocation = { lat: null, lon: null, accuracy: null };
        let html5QrcodeScanner = null;
        let watchId = null;
        let isMockMode = false;

        window.switchView = function(viewName) {
            ['home', 'admin', 'scan'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            if (viewName === 'admin') {
                window.generateQR();
            } else if (viewName === 'scan') {
                window.initScanner();
            }
        }

        window.pasteFromClipboard = async function() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('coord-input').value = text;
            } catch (err) {
                Swal.fire('Info', 'Izin clipboard ditolak. Paste manual (Ctrl+V).', 'info');
            }
        }

        document.getElementById('office-radius').addEventListener('input', function(e) {
            document.getElementById('radius-val').innerText = e.target.value + "m";
        });

        window.setOfficeLocationToCurrent = function() {
            if (navigator.geolocation) {
                Swal.fire({
                    title: 'Mendeteksi...',
                    didOpen: () => { Swal.showLoading() }
                });
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('coord-input').value = `${lat}, ${lon}`;
                    Swal.close();
                }, window.handleError);
            } else {
                Swal.fire('Error', 'Browser tidak support GPS.', 'error');
            }
        }

        window.generateQR = function() {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            const qrData = JSON.stringify({
                app: "e-presensi-v1",
                timestamp: Date.now(),
                token: Math.random().toString(36).substring(7)
            });
            new QRCode(qrContainer, {
                text: qrData,
                width: 150,
                height: 150
            });
        }

        // --- SCANNER & GPS LOGIC ---

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; 
            return d * 1000;
        }

        function deg2rad(deg) { return deg * (Math.PI / 180); }

        window.initScanner = function() {
            isMockMode = false;
            document.getElementById('allowed-radius').innerText = "Max " + window.officeConfig.maxDistance + "m";
            
            window.startGpsTracking();
            
            setTimeout(() => {
                if(!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    window.onScanSuccess,
                    window.onScanFailure
                ).catch(err => { console.log("Cam Error: " + err); });
            }, 500);
        }

        window.startGpsTracking = function() {
            if (isMockMode) return; 

            const statusEl = document.getElementById('gps-status');
            const errorBox = document.getElementById('error-message-box');
            errorBox.classList.add('hidden');
            statusEl.innerHTML = '<span class="text-orange-500"><i class="fa-solid fa-spinner fa-spin"></i> Mencari...</span>';

            if (navigator.geolocation) {
                if(watchId) navigator.geolocation.clearWatch(watchId);
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        window.updateLocationUI(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                    }, 
                    window.handleError, 
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
                );
            } else {
                statusEl.innerText = "Browser tdk support GPS";
            }
        }

        window.updateLocationUI = function(lat, lon, accuracy) {
            userLocation.lat = lat;
            userLocation.lon = lon;
            userLocation.accuracy = accuracy;
            
            const distance = getDistanceFromLatLonInMeters(
                userLocation.lat, userLocation.lon,
                window.officeConfig.lat, window.officeConfig.lon
            );

            const statusEl = document.getElementById('gps-status');
            const distEl = document.getElementById('distance-info');

            if(isMockMode) {
                statusEl.innerHTML = '<span class="text-purple-600 font-bold"><i class="fa-solid fa-robot"></i> Mode Testing</span>';
            } else {
                statusEl.innerHTML = '<span class="text-green-600 font-bold">GPS Aktif</span>';
            }
            
            distEl.innerText = Math.round(distance) + " m";
            
            if(distance > window.officeConfig.maxDistance) {
                distEl.className = "text-sm font-bold text-red-500";
            } else {
                distEl.className = "text-sm font-bold text-green-600";
            }
        }

        window.enableMockGPS = function() {
            isMockMode = true;
            if(watchId) navigator.geolocation.clearWatch(watchId);
            document.getElementById('error-message-box').classList.add('hidden');
            
            const fakeLat = window.officeConfig.lat + 0.00001;
            const fakeLon = window.officeConfig.lon + 0.00001;
            
            Swal.fire({
                title: 'Mode Testing',
                text: 'Menggunakan lokasi simulasi dekat kantor.',
                icon: 'info',
                timer: 1500,
                showConfirmButton: false
            });

            window.updateLocationUI(fakeLat, fakeLon, 5);
        }

        window.handleError = function(error) {
            const statusEl = document.getElementById('gps-status');
            const errorBox = document.getElementById('error-message-box');
            const errorText = document.getElementById('error-text');
            let msg = "";

            switch(error.code) {
                case error.PERMISSION_DENIED: msg = "IZIN GPS DITOLAK."; break;
                case error.POSITION_UNAVAILABLE: msg = "SINYAL LEMAH/UNAVAILABLE."; break;
                case error.TIMEOUT: msg = "TIMEOUT GPS."; break;
                default: msg = "Error GPS tidak diketahui.";
            }

            console.error("GPS Error:", msg);
            statusEl.innerHTML = '<span class="text-red-500 font-bold">Gagal</span>';
            errorText.innerText = msg;
            
            // Tampilkan tombol testing jika error
            errorBox.classList.remove('hidden');
        }

        window.stopScannerAndBack = function() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(err => {});
            }
            if (watchId) navigator.geolocation.clearWatch(watchId);
            window.switchView('home');
        }

        window.onScanSuccess = function(decodedText, decodedResult) {
            html5QrcodeScanner.pause();
            try {
                const data = JSON.parse(decodedText);
                if (data.app !== "e-presensi-v1") throw new Error("QR Code Salah!");
                if (!userLocation.lat) throw new Error("Tunggu GPS terkunci...");

                const distance = getDistanceFromLatLonInMeters(
                    userLocation.lat, userLocation.lon,
                    window.officeConfig.lat, window.officeConfig.lon
                );

                if (distance <= window.officeConfig.maxDistance) {
                    Swal.fire({
                        title: 'ABSEN BERHASIL!',
                        html: `<div class="text-sm mt-2">Jarak: <b>${Math.round(distance)}m</b><br>Max: ${window.officeConfig.maxDistance}m</div>`,
                        icon: 'success'
                    }).then(() => window.stopScannerAndBack());
                } else {
                    Swal.fire({
                        title: 'TERLALU JAUH',
                        html: `<div class="text-sm mt-2 text-red-500">Jarak: <b>${Math.round(distance)}m</b><br>Max: ${window.officeConfig.maxDistance}m</div>`,
                        icon: 'error'
                    }).then(() => html5QrcodeScanner.resume());
                }
            } catch (err) {
                Swal.fire('Error', err.message, 'error').then(() => html5QrcodeScanner.resume());
            }
        }
        window.onScanFailure = function(error) {}
    </script>
</body>
</html>
