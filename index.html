<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Presensi GPS & QR</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QRCode.js (Generator) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Html5-QRCode (Scanner) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- SweetAlert2 (Alerts) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Scanner Styles */
        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        #reader video {
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-md p-6 relative overflow-hidden min-h-[600px]">
        
        <!-- Header -->
        <div class="text-center mb-6 border-b pb-4">
            <h1 class="text-2xl font-bold text-gray-800"><i class="fa-solid fa-fingerprint text-blue-600 mr-2"></i>E-Presensi</h1>
            <p class="text-sm text-gray-500">Scan QR & Validasi Lokasi</p>
        </div>

        <!-- VIEW: HOME (Role Selection) -->
        <div id="view-home" class="space-y-4">
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 text-center text-xs text-blue-800">
                <i class="fa-solid fa-circle-info mr-1"></i> 
                Pastikan izinkan akses <b>Kamera</b> & <b>Lokasi</b>.
            </div>

            <button onclick="switchView('scan')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-between group">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-4">
                        <i class="fa-solid fa-user-clock text-xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-sm opacity-80">Karyawan</div>
                        <div class="text-lg">Absen Masuk</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right opacity-50 group-hover:translate-x-1 transition"></i>
            </button>

            <button onclick="switchView('admin')" class="w-full bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 font-semibold py-4 px-6 rounded-xl shadow-sm transition transform active:scale-95 flex items-center justify-between group">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mr-4">
                        <i class="fa-solid fa-shield-halved text-gray-600 text-xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="text-sm text-gray-500">Admin / HRD</div>
                        <div class="text-lg">Konfigurasi</div>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right opacity-30 group-hover:translate-x-1 transition"></i>
            </button>
        </div>

        <!-- VIEW: ADMIN (QR Generator & Config) -->
        <div id="view-admin" class="hidden space-y-4">
            <button onclick="switchView('home')" class="text-gray-500 hover:text-blue-600 mb-2 flex items-center text-sm font-medium">
                <i class="fa-solid fa-arrow-left mr-2"></i> Kembali
            </button>
            
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <h3 class="font-bold text-gray-700 mb-2 text-sm"><i class="fa-solid fa-map-pin text-red-500 mr-2"></i>Lokasi Kantor</h3>
                <div class="text-xs text-gray-600 mb-3 text-justify">
                    <b>Cara Pakai:</b> Buka Google Maps, klik kanan lokasi kantor, salin angka koordinat (contoh: <code>-6.2088, 106.8456</code>), lalu paste di bawah ini.
                </div>
                
                <!-- INPUT KOORDINAT SATU KOLOM -->
                <div class="mb-3">
                    <label class="text-xs font-bold text-gray-500 block mb-1">Koordinat Maps (Lat, Lon)</label>
                    <div class="flex">
                        <input type="text" id="coord-input" class="w-full text-sm p-2 rounded-l border border-r-0 border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 outline-none" placeholder="-6.1753, 106.8271">
                        <button onclick="pasteFromClipboard()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded-r border border-l-0 border-gray-300" title="Paste">
                            <i class="fa-solid fa-paste"></i>
                        </button>
                    </div>
                </div>

                <!-- Radius Slider -->
                <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-500">Radius Toleransi</label>
                        <span id="radius-val" class="text-xs font-bold text-blue-600">100m</span>
                    </div>
                    <input type="range" id="office-radius" min="20" max="1000" step="10" value="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <p class="text-[10px] text-gray-400">Geser ke kanan jika sinyal GPS Karyawan sering lompat.</p>
                </div>

                <div class="flex gap-2">
                    <button onclick="setOfficeLocationToCurrent()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-2 px-2 rounded transition">
                        <i class="fa-solid fa-location-crosshairs"></i> Gunakan GPS Saat Ini
                    </button>
                    <button onclick="saveConfigManual()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-2 rounded transition">
                        <i class="fa-solid fa-save"></i> Simpan
                    </button>
                </div>
                 <div class="mt-2 text-center">
                    <a href="https://www.google.com/maps" target="_blank" class="text-xs text-blue-500 underline">Buka Google Maps (Cari Koordinat)</a>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center p-6 bg-white rounded-xl border border-dashed border-gray-300">
                <div id="qrcode" class="mb-4"></div>
                <p class="text-xs text-gray-400 text-center mb-4">Scan untuk Absen</p>
                <button onclick="generateQR()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition">
                    <i class="fa-solid fa-arrows-rotate mr-2"></i> Refresh QR
                </button>
            </div>
        </div>

        <!-- VIEW: SCAN (Employee) -->
        <div id="view-scan" class="hidden flex flex-col h-full">
            <button onclick="stopScannerAndBack()" class="text-gray-500 hover:text-blue-600 mb-4 flex items-center text-sm font-medium">
                <i class="fa-solid fa-arrow-left mr-2"></i> Batal
            </button>

            <div class="flex-grow flex flex-col items-center">
                <!-- Status Box -->
                <div class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4 space-y-2">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                         <div>
                            <p class="text-xs text-gray-500">Status GPS</p>
                            <p id="gps-status" class="text-sm font-bold text-orange-500"><i class="fa-solid fa-spinner fa-spin"></i> Mencari...</p>
                        </div>
                        <button onclick="startGpsTracking()" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded hover:bg-gray-100">
                            <i class="fa-solid fa-rotate"></i> Retry
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-500">Radius Diizinkan</p>
                            <p id="allowed-radius" class="text-xs font-mono text-blue-600">Max 100m</p>
                        </div>
                         <div class="text-right">
                            <p class="text-xs text-gray-500">Jarak ke Kantor</p>
                            <p id="distance-info" class="text-sm font-bold text-gray-700">- m</p>
                        </div>
                    </div>
                </div>

                <!-- Camera Area -->
                <div class="relative w-full bg-black rounded-lg overflow-hidden shadow-xl" style="min-height: 250px;">
                    <div id="reader" class="w-full h-full"></div>
                    <div class="absolute inset-0 border-2 border-blue-500/50 pointer-events-none flex items-center justify-center">
                        <div class="w-48 h-48 border-2 border-white/80 rounded-lg"></div>
                    </div>
                </div>
                
                <!-- Error & Mock Button Container -->
                <div id="error-message-box" class="hidden mt-4 p-3 bg-red-100 text-red-700 text-xs rounded border border-red-200 w-full text-center flex flex-col gap-2">
                    <span id="error-text">Error message here</span>
                    <button onclick="enableMockGPS()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-4 rounded w-full">
                        <i class="fa-solid fa-flask mr-1"></i> Gunakan Lokasi Palsu (Testing)
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- KONFIGURASI DEFAULT ---
        let officeConfig = {
            lat: -6.175392, // Monas Default
            lon: 106.827153,
            maxDistance: 100 // meter
        };
        
        let userLocation = { lat: null, lon: null, accuracy: null };
        let html5QrcodeScanner = null;
        let watchId = null;
        let isMockMode = false;

        // --- NAVIGASI ---
        function switchView(viewName) {
            ['home', 'admin', 'scan'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            if (viewName === 'admin') {
                initAdmin();
            } else if (viewName === 'scan') {
                initScanner();
            }
        }

        // --- UTILS ---
        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; 
            return d * 1000;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- ADMIN LOGIC ---
        function initAdmin() {
            // Load Saved Data
            const savedLat = localStorage.getItem('office_lat');
            const savedLon = localStorage.getItem('office_lon');
            const savedRad = localStorage.getItem('office_rad');
            
            if(savedLat && savedLon) {
                officeConfig.lat = parseFloat(savedLat);
                officeConfig.lon = parseFloat(savedLon);
            }
            if(savedRad) {
                officeConfig.maxDistance = parseInt(savedRad);
            }

            // Populate Form (Format: Lat, Lon)
            const combinedCoord = `${officeConfig.lat}, ${officeConfig.lon}`;
            document.getElementById('coord-input').value = combinedCoord;
            
            document.getElementById('office-radius').value = officeConfig.maxDistance;
            document.getElementById('radius-val').innerText = officeConfig.maxDistance + "m";

            // Slider Listener
            document.getElementById('office-radius').addEventListener('input', function(e) {
                document.getElementById('radius-val').innerText = e.target.value + "m";
            });

            generateQR();
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('coord-input').value = text;
            } catch (err) {
                Swal.fire('Info', 'Izin clipboard ditolak. Silakan paste manual (Ctrl+V).', 'info');
            }
        }

        function saveConfigManual() {
            const rawInput = document.getElementById('coord-input').value;
            const radInput = parseInt(document.getElementById('office-radius').value);

            // Parsing "Lat, Lon"
            // Menerima spasi atau tidak setelah koma
            const parts = rawInput.split(',');
            
            if (parts.length !== 2) {
                Swal.fire('Format Salah', 'Gunakan format: Latitude, Longitude (Contoh: -6.2, 106.8)', 'error');
                return;
            }

            const lat = parseFloat(parts[0].trim());
            const lon = parseFloat(parts[1].trim());

            if(isNaN(lat) || isNaN(lon)) {
                Swal.fire('Error', 'Koordinat harus berupa angka.', 'error');
                return;
            }

            officeConfig.lat = lat;
            officeConfig.lon = lon;
            officeConfig.maxDistance = radInput;

            localStorage.setItem('office_lat', lat);
            localStorage.setItem('office_lon', lon);
            localStorage.setItem('office_rad', radInput);

            Swal.fire('Tersimpan', `Lokasi: ${lat}, ${lon} <br> Radius: ${radInput}m`, 'success');
            generateQR();
        }

        function setOfficeLocationToCurrent() {
            if (navigator.geolocation) {
                Swal.fire({
                    title: 'Mendeteksi...',
                    didOpen: () => { Swal.showLoading() }
                });
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Update Input Box
                    document.getElementById('coord-input').value = `${lat}, ${lon}`;
                    
                    // Auto Save
                    saveConfigManual();
                    
                }, handleError);
            } else {
                Swal.fire('Error', 'Browser tidak support GPS.', 'error');
            }
        }

        function generateQR() {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            const qrData = JSON.stringify({
                app: "e-presensi-v1",
                timestamp: Date.now(),
                token: Math.random().toString(36).substring(7)
            });
            new QRCode(qrContainer, {
                text: qrData,
                width: 150,
                height: 150
            });
        }

        // --- SCANNER & GPS ---
        function initScanner() {
            isMockMode = false;
            const savedRad = localStorage.getItem('office_rad');
            if(savedRad) officeConfig.maxDistance = parseInt(savedRad);

            document.getElementById('allowed-radius').innerText = "Max " + officeConfig.maxDistance + "m";
            
            startGpsTracking();
            
            setTimeout(() => {
                if(!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    console.log("Camera Error: " + err);
                });
            }, 500);
        }

        function startGpsTracking() {
            if (isMockMode) return; 

            const statusEl = document.getElementById('gps-status');
            const errorBox = document.getElementById('error-message-box');

            errorBox.classList.add('hidden');
            statusEl.innerHTML = '<span class="text-orange-500"><i class="fa-solid fa-spinner fa-spin"></i> Mencari...</span>';

            if (navigator.geolocation) {
                if(watchId) navigator.geolocation.clearWatch(watchId);

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        updateLocationUI(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                    }, 
                    handleError, 
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0, 
                        timeout: 15000 
                    }
                );
            } else {
                statusEl.innerText = "Browser tdk support GPS";
            }
        }

        function updateLocationUI(lat, lon, accuracy) {
            userLocation.lat = lat;
            userLocation.lon = lon;
            userLocation.accuracy = accuracy;
            
            const distance = getDistanceFromLatLonInMeters(
                userLocation.lat, userLocation.lon,
                officeConfig.lat, officeConfig.lon
            );

            const statusEl = document.getElementById('gps-status');
            const distEl = document.getElementById('distance-info');

            if(isMockMode) {
                statusEl.innerHTML = '<span class="text-purple-600 font-bold"><i class="fa-solid fa-robot"></i> Mode Testing</span>';
            } else {
                statusEl.innerHTML = '<span class="text-green-600 font-bold">GPS Aktif</span>';
            }
            
            distEl.innerText = Math.round(distance) + " m";
            
            if(distance > officeConfig.maxDistance) {
                    distEl.className = "text-sm font-bold text-red-500";
            } else {
                    distEl.className = "text-sm font-bold text-green-600";
            }
        }

        function enableMockGPS() {
            isMockMode = true;
            if(watchId) navigator.geolocation.clearWatch(watchId);
            document.getElementById('error-message-box').classList.add('hidden');
            
            const fakeLat = officeConfig.lat + 0.00001;
            const fakeLon = officeConfig.lon + 0.00001;
            
            Swal.fire({
                title: 'Mode Testing',
                text: 'Menggunakan lokasi simulasi dekat kantor.',
                icon: 'info',
                timer: 1500,
                showConfirmButton: false
            });

            updateLocationUI(fakeLat, fakeLon, 5);
        }

        function handleError(error) {
            const statusEl = document.getElementById('gps-status');
            const errorBox = document.getElementById('error-message-box');
            const errorText = document.getElementById('error-text');
            let msg = "";

            switch(error.code) {
                case error.PERMISSION_DENIED:
                    msg = "IZIN GPS DITOLAK. Cek pengaturan browser HP Anda.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    msg = "SINYAL LEMAH. Coba keluar ruangan atau dekat jendela.";
                    break;
                case error.TIMEOUT:
                    msg = "TIMEOUT. GPS HP lambat merespon. Coba tekan Retry.";
                    break;
                default:
                    msg = "Error GPS tidak diketahui.";
            }

            console.error("GPS Error:", msg);
            statusEl.innerHTML = '<span class="text-red-500 font-bold">Gagal</span>';
            errorText.innerText = msg;
            errorBox.classList.remove('hidden');
        }

        function stopScannerAndBack() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(err => {});
            }
            if (watchId) navigator.geolocation.clearWatch(watchId);
            switchView('home');
        }

        function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.pause();

            try {
                const data = JSON.parse(decodedText);
                if (data.app !== "e-presensi-v1") throw new Error("QR Code Salah!");

                if (!userLocation.lat) throw new Error("GPS HP belum terkunci. Tunggu sebentar...");

                const distance = getDistanceFromLatLonInMeters(
                    userLocation.lat, userLocation.lon,
                    officeConfig.lat, officeConfig.lon
                );

                if (distance <= officeConfig.maxDistance) {
                    Swal.fire({
                        title: 'ABSEN BERHASIL!',
                        html: `
                            <div class="text-left text-sm mt-2">
                                <p>Jarak: <b>${Math.round(distance)}m</b></p>
                                <p>Radius Max: <b>${officeConfig.maxDistance}m</b></p>
                                <p class="text-green-600 mt-2">Anda berada dalam area kantor.</p>
                            </div>
                        `,
                        icon: 'success'
                    }).then(() => stopScannerAndBack());
                } else {
                    Swal.fire({
                        title: 'DITOLAK: TERLALU JAUH',
                        html: `
                            <div class="text-left text-sm mt-2">
                                <p>Jarak Anda: <b class="text-red-500">${Math.round(distance)}m</b></p>
                                <p>Radius Max: <b>${officeConfig.maxDistance}m</b></p>
                                <hr class="my-2">
                                <p class="text-xs text-gray-500">Saran: Minta Admin memperbesar "Radius Toleransi" atau update lokasi kantor.</p>
                            </div>
                        `,
                        icon: 'error'
                    }).then(() => html5QrcodeScanner.resume());
                }

            } catch (err) {
                Swal.fire('Error', err.message, 'error').then(() => html5QrcodeScanner.resume());
            }
        }
        function onScanFailure(error) {}
    </script>
</body>
</html>
